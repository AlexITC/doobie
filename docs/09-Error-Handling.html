<html><head><title>doobie: Error Handling</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Rob Norris" /><meta name="description" content="A functional JDBC layer for Scala." /><meta name="og:image" content="/doobie/img/poster.png" /><meta name="image" property="og:image" content="/doobie/img/poster.png" /><meta name="og:title" content="doobie: Error Handling" /><meta name="title" property="og:title" content="doobie: Error Handling" /><meta name="og:site_name" content="doobie" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="A functional JDBC layer for Scala." /><link rel="icon" type="image/png" href="/doobie/img/favicon.png" /><meta name="twitter:title" content="doobie: Error Handling" /><meta name="twitter:image" content="/doobie/img/poster.png" /><meta name="twitter:description" content="A functional JDBC layer for Scala." /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/doobie/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/doobie/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/doobie/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/doobie/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/doobie/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/doobie/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/doobie/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/doobie/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/doobie/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/doobie/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/doobie/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/doobie/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/doobie/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/doobie/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/doobie/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/doobie/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/doobie/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/doobie/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/doobie/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/doobie/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/doobie/highlight/styles/color-brewer.css" /><link rel="stylesheet" href="/doobie/css/style.css" /><link rel="stylesheet" href="/doobie/css/palette.css" /><link rel="stylesheet" href="/doobie/css/codemirror.css" /><link rel="stylesheet" href="/doobie/css/tweak.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/doobie/" class="brand"><div class="brand-wrapper"><span>doobie</span></div></a></li><li><a href="/doobie/css/style.css" class=""></a></li><li><a href="/doobie/docs/02-Toolkit.html" class="">Toolkit</a></li><li><a href="/doobie/docs/03-Connecting.html" class="">Connecting to a Database</a></li><li><a href="/doobie/docs/04-Selecting.html" class="">Selecting Data</a></li><li><a href="/doobie/docs/05-Parameterized.html" class="">Parameterized Queries</a></li><li><a href="/doobie/docs/06-Checking.html" class="">Typechecking Queries</a></li><li><a href="/doobie/docs/07-Updating.html" class="">DDL, Inserting, and Updating</a></li><li><a href="/doobie/docs/08-Fragments.html" class="">Statement Fragments</a></li><li><a href="/doobie/docs/09-Error-Handling.html" class=" active ">Error Handling</a></li><li><a href="/doobie/docs/10-Logging.html" class="">Logging</a></li><li><a href="/doobie/docs/11-Arrays.html" class="">SQL Arrays</a></li><li><a href="/doobie/docs/12-Custom-Mappings.html" class="">Custom Mappings</a></li><li><a href="/doobie/docs/13-Unit-Testing.html" class="">Unit Testing</a></li><li><a href="/doobie/docs/14-Managing-Connections.html" class="">Managing Connections</a></li><li><a href="/doobie/docs/15-Extensions-PostgreSQL.html" class="">Extensions for PostgreSQL</a></li><li><a href="/doobie/docs/16-Extensions-H2.html" class="">Extensions for H2</a></li><li><a href="/doobie/docs/17-Quill.html" class="">Quill Integration</a></li><li><a href="/doobie/docs/18-FAQ.html" class="">Frequently-Asked Questions</a></li><li><a href="/doobie/" class=""></a></li><li><a href="/doobie/css/palette.css" class=""></a></li><li><a href="/doobie/docs/01-Introduction.html" class="">Introduction</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/tpolecat/doobie"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/tpolecat/doobie"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('doobie A functional JDBC layer for Scala.');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('doobie A functional JDBC layer for Scala.');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="tpolecat" data-github-repo="doobie"><div class="content-wrapper"><section><h2 id="error-handling">Error Handling</h2>

<p>In this chapter we examine a set of combinators that allow us to construct programs that trap and handle exceptions.</p>

<h3 id="setting-up">Setting Up</h3>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">doobie._</span>
<span class="k">import</span> <span class="nn">doobie.implicits._</span>
<span class="k">import</span> <span class="nn">doobie.util.ExecutionContexts</span>
<span class="k">import</span> <span class="nn">cats._</span>
<span class="k">import</span> <span class="nn">cats.data._</span>
<span class="k">import</span> <span class="nn">cats.effect._</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>

<span class="c1">// We need a ContextShift[IO] before we can construct a Transactor[IO]. The passed ExecutionContext
// is where nonblocking operations will be executed. For testing here we're using a synchronous EC.
</span><span class="k">implicit</span> <span class="k">val</span> <span class="n">cs</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">.</span><span class="n">contextShift</span><span class="o">(</span><span class="nc">ExecutionContexts</span><span class="o">.</span><span class="n">synchronous</span><span class="o">)</span>

<span class="c1">// A transactor that gets connections from java.sql.DriverManager and executes blocking operations
// on an our synchronous EC. See the chapter on connection handling for more info.
</span><span class="k">val</span> <span class="n">xa</span> <span class="k">=</span> <span class="nc">Transactor</span><span class="o">.</span><span class="n">fromDriverManager</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span>
  <span class="s">"org.postgresql.Driver"</span><span class="o">,</span>     <span class="c1">// driver classname
</span>  <span class="s">"jdbc:postgresql:world"</span><span class="o">,</span>     <span class="c1">// connect URL (driver-specific)
</span>  <span class="s">"postgres"</span><span class="o">,</span>                  <span class="c1">// user
</span>  <span class="s">""</span><span class="o">,</span>                          <span class="c1">// password
</span>  <span class="nc">Blocker</span><span class="o">.</span><span class="n">liftExecutionContext</span><span class="o">(</span><span class="nc">ExecutionContexts</span><span class="o">.</span><span class="n">synchronous</span><span class="o">)</span> <span class="c1">// just for testing
</span><span class="o">)</span>

<span class="k">val</span> <span class="n">y</span> <span class="k">=</span> <span class="n">xa</span><span class="o">.</span><span class="n">yolo</span>
<span class="k">import</span> <span class="nn">y._</span>
</code></pre>
</div>

<h3 id="about-exceptions">About Exceptions</h3>

<p>Exceptions are a fact of life when interacting with databases, and they are largely nondeterministic; whether an operation will succeed or not depends on unpredictable factors like network health, the current contents of tables, locking state, and so on. So we must decide whether to compute everything in a disjunction like <code class="highlighter-rouge">EitherT[ConnectionIO, Throwable, A]</code> or allow exceptions to propagate until they are caught explicitly. <strong>doobie</strong> adopts the second strategy: exceptions are allowed to propagate and escape unless handled explicitly (exactly as <code class="highlighter-rouge">IO</code> works). This means when a <strong>doobie</strong> action (transformed to some target monad) is executed, exceptions can escape.</p>

<p>There are three main types of exceptions that are likely to arise:</p>

<ol>
  <li>Various types of <code class="highlighter-rouge">IOException</code> can happen with any kind of I/O, and these exceptions tend to be unrecoverable.</li>
  <li>Database exceptions, typically as a generic <code class="highlighter-rouge">SQLException</code> with a vendor-specific <code class="highlighter-rouge">SQLState</code> identifying the specific error, are raised for common situations such as key violations. Some vendors (PostgreSQL for instance) publish a table of error codes, and in these cases <strong>doobie</strong> can provide a matching set of exception-handling combinators. However in most cases the error codes must be passed down as folklore or discovered by experimentation. There exist the XOPEN and SQL:2003 standards, but it seems that no vendor adheres closely to these specifications. Some of these errors are recoverable and others aren’t.</li>
  <li><strong>doobie</strong> will raise an <code class="highlighter-rouge">InvariantViolation</code> in response to invalid type mappings, unknown JDBC constants returned by drivers, observed <code class="highlighter-rouge">NULL</code> values, and other violations of invariants that <strong>doobie</strong> assumes. These exceptions indicate programmer error or driver non-compliance and are generally unrecoverable.</li>
</ol>

<h3 id="monaderror-and-derived-combinators"><code class="highlighter-rouge">MonadError</code> and Derived Combinators</h3>

<p>All <strong>doobie</strong> monads provide an <code class="highlighter-rouge">Async</code> instance, which extends <code class="highlighter-rouge">MonadError[?[_], Throwable]</code>. This means <code class="highlighter-rouge">ConnectionIO</code>, etc., have the following primitive operations:</p>

<ul>
  <li><code class="highlighter-rouge">.attempt</code> converts <code class="highlighter-rouge">M[A]</code> into <code class="highlighter-rouge">M[Either[Throwable, A]]</code></li>
  <li><code class="highlighter-rouge">fail</code> constructs an <code class="highlighter-rouge">M[A]</code> that fails with a provided <code class="highlighter-rouge">Throwable</code></li>
</ul>

<p>So any <strong>doobie</strong> program can be lifted into a disjunction simply by adding <code class="highlighter-rouge">.attempt</code>.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">val</span> <span class="n">p</span> <span class="k">=</span> <span class="mf">42.</span><span class="n">pure</span><span class="o">[</span><span class="kt">ConnectionIO</span><span class="o">]</span>
<span class="c1">// p: ConnectionIO[Int] = Pure(42)
</span><span class="n">p</span><span class="o">.</span><span class="n">attempt</span>
<span class="c1">// res0: ConnectionIO[Either[Throwable, Int]] = Suspend(
//   HandleErrorWith(
//     FlatMapped(Pure(42), cats.Monad$$Lambda$8144/773217938@2bab87cb),
//     cats.ApplicativeError$$Lambda$8235/2046171693@2d546afa
//   )
// )
</span></code></pre>
</div>

<p>From the <code class="highlighter-rouge">.attempt</code> and <code class="highlighter-rouge">fail</code> combinators we can derive many other operations, as described in the Cats documentation. In addition <strong>doobie</strong> provides the following specialized combinators that only pay attention to <code class="highlighter-rouge">SQLException</code>:</p>

<ul>
  <li><code class="highlighter-rouge">attemptSql</code> is like <code class="highlighter-rouge">attempt</code> but only traps <code class="highlighter-rouge">SQLException</code>.</li>
  <li><code class="highlighter-rouge">attemptSomeSql</code> traps only specified <code class="highlighter-rouge">SQLException</code>s.</li>
  <li><code class="highlighter-rouge">exceptSql</code> recovers from an <code class="highlighter-rouge">SQLException</code> with a new action.</li>
  <li><code class="highlighter-rouge">onSqlException</code> executes an action on <code class="highlighter-rouge">SQLException</code> and discards its result.</li>
</ul>

<p>And finally we have a set of combinators that focus on <code class="highlighter-rouge">SQLState</code>s.</p>

<ul>
  <li><code class="highlighter-rouge">attemptSqlState</code> is like <code class="highlighter-rouge">attemptSql</code> but yields <code class="highlighter-rouge">M[Either[SQLState, A]]</code>.</li>
  <li><code class="highlighter-rouge">attemptSomeSqlState</code> traps only specified <code class="highlighter-rouge">SQLState</code>s.</li>
  <li><code class="highlighter-rouge">exceptSqlState</code> recovers from an <code class="highlighter-rouge">SQLState</code> with a new action.</li>
  <li><code class="highlighter-rouge">exceptSomeSqlState</code>  recovers from specified <code class="highlighter-rouge">SQLState</code>s with a new action.</li>
</ul>

<p>See the ScalaDoc for more information.</p>

<h3 id="example-unique-constraint-violation">Example: Unique Constraint Violation</h3>

<p>Ok let’s set up a <code class="highlighter-rouge">person</code> table again, using a slightly different formulation just for fun. Note that the <code class="highlighter-rouge">name</code> column is marked as being unique.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="nc">List</span><span class="o">(</span>
  <span class="n">sql</span><span class="s">"""DROP TABLE IF EXISTS person"""</span><span class="o">,</span>
  <span class="n">sql</span><span class="s">"""CREATE TABLE person (
          id    SERIAL,
          name  VARCHAR NOT NULL UNIQUE
        )"""</span>
<span class="o">).</span><span class="n">traverse</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">quick</span><span class="o">).</span><span class="n">void</span><span class="o">.</span><span class="n">unsafeRunSync</span>
<span class="c1">//   0 row(s) updated
//   0 row(s) updated
</span></code></pre>
</div>

<p>Alright, let’s define a <code class="highlighter-rouge">Person</code> data type and a way to insert instances.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Person</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">def</span> <span class="n">insert</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">ConnectionIO</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="n">sql</span><span class="s">"insert into person (name) values ($s)"</span>
    <span class="o">.</span><span class="n">update</span>
    <span class="o">.</span><span class="n">withUniqueGeneratedKeys</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="s">"name"</span><span class="o">)</span>
<span class="o">}</span>
</code></pre>
</div>

<p>The first insert will work.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">insert</span><span class="o">(</span><span class="s">"bob"</span><span class="o">).</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span>
<span class="c1">//   Person(1,bob)
</span></code></pre>
</div>

<p>The second will fail with a unique constraint violation.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">try</span> <span class="o">{</span>
  <span class="n">insert</span><span class="o">(</span><span class="s">"bob"</span><span class="o">).</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
  <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">java.sql.SQLException</span> <span class="o">=&gt;</span>
    <span class="n">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="o">)</span>
    <span class="n">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="n">getSQLState</span><span class="o">)</span>
<span class="o">}</span>
<span class="c1">// ERROR: duplicate key value violates unique constraint "person_name_key"
//   Detail: Key (name)=(bob) already exists.
// 23505
</span></code></pre>
</div>

<p>So let’s change our method to return an <code class="highlighter-rouge">Either[String, Person]</code> by using the <code class="highlighter-rouge">attemptSomeSql</code> combinator. This allows us to specify the <code class="highlighter-rouge">SQLState</code> value that we want to trap. In this case the culprit <code class="highlighter-rouge">"23505"</code> (yes, it’s a string) is provided as a constant in the <code class="highlighter-rouge">doobie-postgres</code> add-on.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">doobie.postgres._</span>

<span class="k">def</span> <span class="n">safeInsert</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">ConnectionIO</span><span class="o">[</span><span class="kt">Either</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Person</span><span class="o">]]</span> <span class="k">=</span>
  <span class="n">insert</span><span class="o">(</span><span class="n">s</span><span class="o">).</span><span class="n">attemptSomeSqlState</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">sqlstate</span><span class="o">.</span><span class="n">class23</span><span class="o">.</span><span class="nc">UNIQUE_VIOLATION</span> <span class="k">=&gt;</span> <span class="s">"Oops!"</span>
  <span class="o">}</span>
</code></pre>
</div>

<p>Given this definition we can safely attempt to insert duplicate records and get a helpful error message rather than an exception.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">safeInsert</span><span class="o">(</span><span class="s">"bob"</span><span class="o">).</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span>
<span class="c1">//   Left(Oops!)
</span>
<span class="n">safeInsert</span><span class="o">(</span><span class="s">"steve"</span><span class="o">).</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span>
<span class="c1">//   Right(Person(4,steve))
</span></code></pre>
</div>

</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/doobie/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlighting();
              </script><script src="/doobie/js/main.js"></script></body></html>